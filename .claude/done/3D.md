# 3D: Multi-Timeframe Data Support

## What Was Implemented

Added the ability for strategies to request and use multi-timeframe data (weekly, monthly) alongside daily bars. The engine resamples daily OHLCV data using proper aggregation rules and passes it to strategies during indicator computation and signal generation.

## Files Changed

### `src/backtester/data/manager.py`
- Added `resample_ohlcv(df, timeframe)` function that resamples daily OHLCV to weekly or monthly
- OHLCV rules: Open=first, High=max, Low=min, Close=last, Volume=sum
- Index uses the last actual trading day in each period (not calendar period-end)
- Handles partial periods at data boundaries

### `src/backtester/strategies/base.py`
- Added `timeframes` property to Strategy ABC (default: `['daily']`)
- Extended `compute_indicators()` abstract method signature with optional `timeframe_data: dict[str, pd.DataFrame] | None = None`
- Fully backward-compatible: existing strategies that don't override `timeframes` work unchanged

### `src/backtester/strategies/sma_crossover.py`
- Updated `compute_indicators()` signature to accept optional `timeframe_data` parameter (ignored; backward-compatible)

### `src/backtester/strategies/rule_based.py`
- Updated `compute_indicators()` signature to accept optional `timeframe_data` parameter (ignored; backward-compatible)

### `src/backtester/engine.py`
- After loading daily data, checks `strategy.timeframes` for non-daily timeframes
- Resamples daily data per ticker using `resample_ohlcv()` for each requested timeframe
- Forward-fills resampled data onto the daily index so strategies can look up current period values
- Passes `timeframe_data` dict to `strategy.compute_indicators()`
- Merges forward-filled timeframe columns (prefixed, e.g. `weekly_Close`) into daily DataFrames so `generate_signals()` can access them via the row
- Day loop order is NOT changed; T/T+1 fill timing invariant is preserved

## Tests Added

### `tests/test_multi_timeframe.py` (16 tests)

**resample_ohlcv (7 tests):**
- Weekly OHLCV aggregation correctness (O=first, H=max, L=min, C=last, V=sum)
- Monthly OHLCV aggregation correctness
- Partial periods at boundaries are included
- Index uses last trading day (not calendar period-end)
- Invalid timeframe raises ValueError
- Input DataFrame is not mutated
- Output columns match OHLCV

**Strategy.timeframes (2 tests):**
- Default returns `['daily']` for sma_crossover
- Default returns `['daily']` for rule_based

**compute_indicators with timeframe_data (2 tests):**
- Multi-timeframe strategy receives timeframe_data dict
- Existing strategies work without timeframe_data (backward compat)

**Engine integration (5 tests):**
- Multi-timeframe strategy gets resampled data passed through engine
- Weekly-prefixed columns appear in daily DataFrame after engine processing
- Backward compatibility: sma_crossover runs unchanged
- Backward compatibility: rule_based runs unchanged
- Forward-filled weekly data covers all daily dates after first period

## Deviations

None. All requirements were met as specified.

## Test Results

- All 16 new tests pass
- All 324 existing tests continue to pass (340 total, 2 pre-existing warnings)
