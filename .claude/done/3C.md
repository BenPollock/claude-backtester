# Feature 3C: Limit Order Execution -- Completion Note

## What Was Implemented

Full limit order support in the backtesting engine: strategies can now return limit order parameters alongside signals, the broker checks intraday High/Low ranges to determine if limit prices are reachable, DAY orders expire at end of day while GTC orders persist across days, and all existing market order / short selling behavior is preserved.

## Files Changed

### `src/backtester/strategies/base.py`
- Added `Signal` frozen dataclass wrapping `SignalAction` with optional limit order fields:
  - `action: SignalAction` -- the trading signal
  - `limit_price: float | None = None` -- submits a limit order if set
  - `time_in_force: str = "DAY"` -- `"DAY"` or `"GTC"`
  - `expiry_date: date | None = None` -- optional explicit expiry for GTC orders
- Updated `generate_signals()` return type annotation to `SignalAction | Signal`
- Updated docstring to document the new return type
- Added `date` import from `datetime`

### `src/backtester/execution/broker.py`
- Extracted `_determine_fill_price()` method: returns the base fill price for an order. Market orders return Open; limit orders return the limit price if the day's High/Low range reaches it, otherwise `None`.
- Added `_handle_unfilled_order()` method: DAY orders are cancelled with `reason="day_expired"`; GTC orders have `days_pending` incremented and stay pending, unless `expiry_date` has been reached (then cancelled with `reason="expired"`).
- Modified `process_fills()`: calls `_determine_fill_price()` first; if it returns `None` (limit not reached), delegates to `_handle_unfilled_order()` instead of filling. Slippage is applied around the base fill price (limit price for limits, Open for market).
- Added `OrderType` import from `backtester.types`
- All existing market order and short selling (reason-based routing) behavior is fully preserved.

### `src/backtester/engine.py`
- Added `Signal` import from `backtester.strategies.base`
- Signal processing now unwraps `Signal` objects: extracts `action`, `limit_price`, `time_in_force`, and `expiry_date`. Plain `SignalAction` returns still work (default limit_price=None, time_in_force="DAY").
- Order construction sets `order_type=OrderType.LIMIT` when `limit_price` is not None, otherwise `OrderType.MARKET`.
- Passes `limit_price`, `time_in_force`, and `expiry_date` through to the `Order` constructor.

### `src/backtester/portfolio/order.py`
- **No changes needed** -- the `Order` dataclass already had `limit_price`, `time_in_force`, `expiry_date`, and `days_pending` fields (added in a prior commit but previously unused by the broker).

## Tests Added

`tests/test_limit_orders.py` -- 39 tests across 14 test classes:

| Class | Count | What it tests |
|-------|-------|---------------|
| TestMarketOrderRegression | 3 | Market BUY/SELL still fill at Open, default field values |
| TestBuyLimitOrder | 4 | BUY limit fills when Low <= limit, at limit price; does NOT fill when Low > limit; position created |
| TestSellLimitOrder | 3 | SELL limit fills when High >= limit, at limit price; does NOT fill when High < limit |
| TestDayOrderExpiry | 2 | DAY buy/sell limit orders cancelled when not filled |
| TestGTCOrder | 3 | GTC persists when not filled, fills on later day, GTC sell persists and fills |
| TestGTCExpiry | 2 | GTC cancelled after expiry_date, fills before expiry |
| TestDaysPending | 2 | days_pending increments for GTC, stays zero for DAY orders |
| TestLimitOrderSlippage | 2 | Slippage applied around limit price for both BUY and SELL |
| TestLimitOrderFees | 2 | Fees deducted correctly on limit BUY and SELL |
| TestShortWithLimitOrder | 3 | Short entry via limit, cover via limit, short entry limit not reached |
| TestSignalDataclass | 4 | Default values, full construction, frozen immutability, action comparison |
| TestBackwardCompatibility | 2 | Strategy returning SignalAction works, Strategy returning Signal works |
| TestLimitOrderEdgeCases | 5 | Missing Low data, None limit_price, insufficient cash, sell-all sentinel, no market data |
| TestLimitOrderActivityLog | 2 | Activity log entries for limit BUY and SELL fills |

## Deviations from Spec

- **No partial fills**: The spec mentioned partial fills as optional. They are not implemented. Limit orders fill completely or not at all (subject to cash reduction for BUY orders, which matches existing market order behavior).
- **`order.py` already had the fields**: The spec asked to add `limit_price`, `time_in_force`, `expiry_date`, and `days_pending` to `Order`, but these fields already existed in the dataclass. No changes to `order.py` were needed.
- **Slippage measured relative to base price**: For limit orders, the `slippage` field in `Fill` represents `abs(fill_price - limit_price)` rather than `abs(fill_price - open_price)`. This is more meaningful -- it shows slippage relative to the intended fill price.
- **`reason` field handling on expiry**: When a DAY order is cancelled, `reason` is set to `"day_expired"` only if the existing `reason` is empty (preserving `"short_entry"` or `"cover"` values). Similarly, GTC expiry sets `"expired"`.

## Interface Changes for Downstream Code

| Change | Location | Impact |
|--------|----------|--------|
| `Signal` frozen dataclass added | `strategies/base.py` | New optional return type from `generate_signals()`. Backward-compatible -- returning plain `SignalAction` still works. |
| `generate_signals()` return type widened | `strategies/base.py` | Type annotation now `SignalAction \| Signal`. No runtime enforcement change. |
| Engine unwraps `Signal` objects | `engine.py` | Transparent to strategies; both return types handled. |
| `OrderType.LIMIT` now used for limit orders | `engine.py`, `broker.py` | `OrderType.LIMIT` was already defined in `types.py` but unused. Now functional. |
| Broker checks `order.order_type` and `order.limit_price` | `broker.py` | Existing market orders unaffected (order_type=MARKET, limit_price=None). |
| DAY/GTC handling in broker | `broker.py` | New behavior for unfilled limit orders. Market orders always fill on first attempt, so DAY/GTC is only relevant for limit orders. |
