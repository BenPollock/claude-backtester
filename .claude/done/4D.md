# 4D: Multi-Strategy Portfolio Support

## Status: Complete

## What was implemented

New file `src/backtester/research/multi_strategy.py` providing:

1. **`StrategyAllocation`** (frozen dataclass) -- Pairs a strategy name + params with a capital weight (0.0-1.0).

2. **`MultiStrategyConfig`** (frozen dataclass) -- Holds a tuple of allocations and a shared `BacktestConfig`. Validates on construction that weights sum to <= 1.0 and none are negative.

3. **`run_multi_strategy(multi_config, data_manager=None)`** -- Runs each allocation independently via `BacktestEngine.run()` with proportional starting cash, then combines results:
   - Combined equity curve = sum of individual equity curves (plus flat cash for any unallocated weight)
   - Combined metrics computed on the summed curve
   - All trades merged into a single list
   - Unique labels generated when the same strategy appears multiple times (e.g. `sma_crossover_1`, `sma_crossover_2`)

4. **`MultiStrategyResult`** (frozen dataclass) -- Contains combined equity/metrics, per-strategy results/metrics/weights, combined trades, and attribution DataFrame.

5. **`compute_attribution()`** -- Computes each strategy's PnL and its percentage contribution to total portfolio return.

6. **`print_multi_strategy_report()`** -- Formatted console output with combined metrics, per-strategy breakdown table, and attribution analysis.

## Key design decisions

- Each strategy runs in complete isolation with its own capital -- no interaction between strategy portfolios.
- Uses `dataclasses.replace()` to create per-allocation configs from the frozen base config (follows existing research module pattern).
- Failed strategy runs are logged and skipped rather than raising (error-tolerant, like grid_search).
- Accepts optional `data_manager` parameter for testability with `MockDataSource`.
- Duplicate strategy names get `_1`/`_2` suffixes to keep dict keys unique.

## Tests

19 tests in `tests/test_multi_strategy.py`:
- Config validation: frozen, weights > 1.0 rejected, negative weights rejected, valid weights accepted
- Single strategy at weight=1.0 matches direct engine run
- Two strategies: combined equity = sum of individuals, weights stored correctly
- Attribution: contributions sum to 100%, correct columns, single strategy = 100%
- Per-strategy and combined metrics present with expected keys
- Edge cases: zero-trade strategy, uninvested cash remainder, combined trades merge
- Report printing: no errors, expected sections present

## Files changed

- `src/backtester/research/multi_strategy.py` (new)
- `tests/test_multi_strategy.py` (new)
