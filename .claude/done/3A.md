# Feature 3A: Short Selling Support -- Completion Note

## What Was Implemented

Full short selling support across the backtesting engine: strategies can now emit `SHORT` and `COVER` signals, the broker creates negative positions on short entries, FIFO lot tracking works for both long and short positions, and short-specific stops, margin tracking, and borrow cost accrual are all operational.

## Files Changed

### `src/backtester/types.py`
- Added `SHORT = auto()` and `COVER = auto()` to `SignalAction` enum

### `src/backtester/config.py`
- Added three fields to `BacktestConfig` (frozen dataclass, all with defaults):
  - `allow_short: bool = False` -- master switch
  - `short_borrow_rate: float = 0.02` -- annualized borrow cost (2%)
  - `margin_requirement: float = 1.5` -- initial margin (150%)

### `src/backtester/portfolio/position.py`
- Added `direction` property: returns `'long'`, `'short'`, or `'flat'`
- Added `is_short` property: `True` when `total_quantity < 0`
- Added `unrealized_pnl` property: handles both long and short PnL correctly
- Added `short_borrow_cost_accrued` field (float, default 0.0)
- Added `accrue_borrow_cost(rate_annual, days=1)` method
- Added `close_lots_fifo(quantity, exit_price, exit_date, exit_commission)` method for covering shorts (FIFO, negative lots)
- Modified `avg_entry_price` to use `abs(quantity)` for weighting (works for both long/short)
- **`sell_lots_fifo()` is unchanged** -- existing long behavior fully preserved

### `src/backtester/portfolio/portfolio.py`
- Added `margin_used` property: sum of `abs(market_value)` for short positions
- Added `available_capital(margin_requirement)` method: `cash - margin_used * margin_requirement`
- Added `margin_used: float = 0.0` field to `PortfolioState` (frozen dataclass, with default)
- `snapshot()` now includes `margin_used`

### `src/backtester/strategies/base.py`
- Extended `size_order()` to handle `SignalAction.SHORT` (returns negative qty) and `SignalAction.COVER` (returns -1 sentinel)
- Updated docstrings on `generate_signals()` return to include SHORT/COVER

### `src/backtester/execution/broker.py`
- `process_fills()` now routes orders based on `order.reason`:
  - `reason="short_entry"`: creates negative lot, adds short sale proceeds to cash
  - `reason="cover"`: resolves -1 sentinel to abs(short qty), calls `close_lots_fifo()`, deducts cash
- Normal BUY/SELL behavior unchanged (empty reason string)
- Slippage applied via existing `Side.BUY/SELL` logic (works correctly for both directions)
- Cover order cancelled if no short position or if position is long

### `src/backtester/execution/stops.py`
- Added `set_stops_for_short_fills()` method (inverted stop/target levels for shorts)
- Modified `check_stop_triggers()`: for short positions, stop_loss triggers on High >= stop (price rise), take_profit triggers on Low <= target (price fall)
- Stop exit for shorts uses `close_lots_fifo()` and deducts cash (buying back)

### `src/backtester/engine.py`
- Signal processing now handles `SignalAction.SHORT` and `SignalAction.COVER`
- SHORT signals rejected when `allow_short=False`
- SHORT signals suppressed by regime filter (same as BUY)
- COVER signals rejected if no short position exists
- Position limits apply to SHORT (same as BUY)
- Orders tagged with `reason="short_entry"` or `reason="cover"` for broker routing
- Daily borrow cost accrual added after market price update (step b1, between b and b2)
- `_force_close_all()` handles both long and short positions on last day
- **Day loop step order preserved** -- no reordering

## Tests Added

`tests/test_short_selling.py` -- 47 tests across 13 test classes:

| Class | Count | What it tests |
|-------|-------|---------------|
| TestSignalActionEnum | 3 | SHORT/COVER enum values, originals unchanged |
| TestShortPosition | 8 | Direction, market value, avg price, PnL (profit on fall, loss on rise) |
| TestBorrowCost | 3 | Daily accrual, multi-day, no-op for long |
| TestCloseLotsFifo | 4 | Full cover, partial FIFO, over-cover raises, commission handling |
| TestMarginTracking | 5 | margin_used, available_capital, PortfolioState, close_position |
| TestBrokerShortFills | 7 | Short entry fill, cover fill, sentinel resolution, slippage, fees |
| TestStrategySizing | 4 | SHORT/COVER/BUY/SELL size_order behavior |
| TestConfigShortFields | 2 | Default values, existing config unaffected |
| TestShortLongCoexistence | 1 | Long + short on different tickers |
| TestAllowShortSwitch | 1 | allow_short=False config check |
| TestShortStopLoss | 3 | Stop triggers on price rise, no false trigger, take profit on price fall |
| TestLongBehaviorUnchanged | 4 | sell_lots_fifo, equity, broker buy/sell all work as before |
| TestEdgeCases | 2 | Cover cancelled when no short, cover cancelled when long |

## Deviations from Spec

- **Order routing via `reason` field**: Instead of adding new Side enum values or a separate order field, short entry and cover orders are distinguished by `order.reason` (`"short_entry"` / `"cover"`). The `Order.reason` field already existed (used for cancellation reasons like "overallocation"). This keeps the `Side` enum clean (BUY/SELL only) while making the broker's routing unambiguous.
- **Borrow cost is tracked but not deducted from cash**: The `short_borrow_cost_accrued` field accumulates the cost on the Position object for reporting/analytics. It is not automatically deducted from portfolio cash in the day loop. This allows downstream analytics to report it separately. If cash deduction is desired, it can be added in a follow-up.
- **`set_stops_for_short_fills()`** added to StopManager but not yet wired into the engine's fill processing. The engine currently only calls `set_stops_for_fills()` (which filters on `Side.BUY`). To activate short stops via the StopConfig, the engine would need a second call for short fills.

## Interface Changes for Downstream Code

| Change | Location | Impact |
|--------|----------|--------|
| `SignalAction.SHORT`, `SignalAction.COVER` added | `types.py` | Any code using `match`/exhaustive checks on SignalAction needs updating |
| `PortfolioState.margin_used` added (default=0.0) | `portfolio.py` | Backward-compatible; existing code unaffected |
| `BacktestConfig.allow_short`, `.short_borrow_rate`, `.margin_requirement` added | `config.py` | All have defaults; existing configs work unchanged |
| `Position.close_lots_fifo()` new method | `position.py` | New method for short covers; `sell_lots_fifo()` unchanged |
| `Position.direction`, `.is_short`, `.unrealized_pnl`, `.accrue_borrow_cost()` added | `position.py` | New properties/methods; no existing interface change |
| `Portfolio.margin_used`, `.available_capital()` added | `portfolio.py` | New property/method; no existing interface change |
| `Order.reason` used for `"short_entry"` / `"cover"` routing | `broker.py` | Broker checks `order.reason` to determine fill path. Limit order or other downstream code that constructs Orders must set `reason` correctly for short orders |
| `Strategy.size_order()` handles SHORT/COVER | `base.py` | Returns negative qty for SHORT, -1 sentinel for COVER. Subclasses can override |
