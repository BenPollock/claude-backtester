# 4E: Regime Performance Breakdown

## What Was Implemented

New analytics module for classifying market/volatility regimes and computing per-regime performance metrics.

### Functions in `src/backtester/analytics/regime.py`

1. **`classify_market_regime(benchmark_prices, sma_window, sideways_band)`** — Classifies each trading day as 'bull' (price > SMA + band), 'bear' (price < SMA - band), or 'sideways' (within ±band of SMA). First `sma_window - 1` days labeled 'unknown' due to insufficient data.

2. **`classify_volatility_regime(returns, window, percentiles)`** — Computes rolling annualized realized volatility (default 63-day window), then buckets into 'low_vol', 'medium_vol', 'high_vol' using configurable percentile thresholds (default 33rd/67th).

3. **`regime_performance(equity_curve, regime_labels, annual_factor)`** — For each unique regime label, computes: total return (compounded daily returns), annualized return, annualized volatility, Sharpe ratio (rf=0), max drawdown, trading days count, and percentage of total time. Returns a DataFrame with regimes as index.

4. **`regime_summary(equity_curve, benchmark_prices, returns, sma_window, vol_window)`** — Convenience wrapper that classifies both market and volatility regimes, computes performance for each, and returns a dict with four keys: `market_regime_perf`, `vol_regime_perf`, `market_labels`, `vol_labels`.

## Files Changed

| File | Action |
|------|--------|
| `src/backtester/analytics/regime.py` | **Created** — 4 public functions |
| `tests/test_regime.py` | **Created** — 21 tests across 4 test classes |

## Tests Added (21 total)

- **TestClassifyMarketRegime** (7): bull market, bear market, mixed, sideways detection, warmup unknown, empty series, short series
- **TestClassifyVolatilityRegime** (5): three regimes present, warmup unknown, empty series, short series, constant returns
- **TestRegimePerformance** (6): two-regime split, single regime, max drawdown verification, empty equity, single day, annualized volatility positive
- **TestRegimeSummary** (3): end-to-end integration, explicit returns, short data

## Deviations

- The warmup period for 'unknown' labels is `sma_window - 1` days, not `sma_window` days. This follows pandas `rolling(window=N, min_periods=N)` behavior, which produces its first valid value at index N-1. The spec said "First `sma_window` days should be labeled 'unknown'" but the correct count is `sma_window - 1` because the Nth data point completes the first full window.
- No existing files were modified (as specified in the constraints).

## Verification

Full test suite: 340 passed, 0 failed (including 21 new regime tests).
