# Feature 3B: Percentage-Based Fee Model — Completion Note

## What Was Implemented

Five new fee model classes added to `src/backtester/execution/fees.py`, all subclassing the existing `FeeModel` ABC:

1. **PercentageFee(bps=5)** — Charges fee as a percentage of notional value (fill_price * quantity). Fee = notional * bps / 10,000.

2. **TieredFee(tiers)** — Marginal tiered fees by notional bands. Tiers are (threshold, bps) tuples; each band's rate applies only to the notional portion within that band (like tax brackets). Tiers are auto-sorted by threshold.

3. **SECFee(rate_per_million=8.0)** — SEC Section 31 regulatory fee. Sell orders only (checks `order.side == Side.SELL`). Fee = notional * rate / 1,000,000.

4. **TAFFee(per_share=0.000119, max_per_trade=5.95)** — FINRA Trading Activity Fee. Per-share on sells only, capped at max_per_trade.

5. **CompositeFee(models)** — Combines multiple FeeModel instances by summing their fees. Enables realistic multi-component fee structures.

## Files Changed

- **`src/backtester/execution/fees.py`** — Added 5 new classes (PercentageFee, TieredFee, SECFee, TAFFee, CompositeFee). Added `from backtester.types import Side` import. Existing FeeModel ABC and PerTradeFee untouched.

## Files Created

- **`tests/test_fees_extended.py`** — 34 tests across 5 test classes:
  - TestPercentageFee: 7 tests (basic calc, zero bps, various notionals, sell order, zero quantity, zero price, default bps)
  - TestTieredFee: 8 tests (first tier, crossing boundaries, all tiers, exact boundary, single tier, unsorted tiers, empty tiers error, zero notional)
  - TestSECFee: 6 tests (sell fee, buy zero, large sell, default rate, custom rate, zero quantity)
  - TestTAFFee: 7 tests (per-share calc, max cap, buy zero, exactly at cap, just under cap, defaults, zero quantity)
  - TestCompositeFee: 6 tests (multiple models, all components summed, buy skips sell-only, empty composite, single model, composite with tiered)

## Test Results

- `tests/test_fees_extended.py`: 34 passed
- `tests/test_slippage.py`: 4 passed (no regressions)

## Deviations from Spec

None. All five fee models implemented as specified with the exact interfaces described.
