# Feature 4A: HTML Tearsheet / Report Export

## Status: Complete

## What was implemented

### New file: `src/backtester/analytics/tearsheet.py`

A self-contained HTML tearsheet generator for backtest results. The module produces a single HTML file with no external dependencies (all CSS inline, all charts embedded as base64 PNGs).

**Public function:**
- `generate_tearsheet(result: BacktestResult, output_path: str = "tearsheet.html") -> str` — Main entry point. Generates a full HTML tearsheet and returns the output file path.

**Helper functions:**
- `_render_chart_as_base64(fig) -> str` — Converts a matplotlib Figure to a base64-encoded PNG string for HTML embedding.
- `_generate_monthly_returns_html(equity_curve) -> str` — Produces a Year x Month heatmap table with color-coded cells (green for positive returns, red for negative).
- `_generate_trade_table_html(trades, max_rows=20) -> str` — Produces an HTML table of recent trades with PnL coloring.

**HTML tearsheet sections:**
1. **Header** — Strategy name, date range, initial capital, final equity, tickers, benchmark
2. **Key Metrics** — 8-card grid: CAGR, Sharpe, Sortino, Max Drawdown, Calmar, Win Rate, Profit Factor, Total Trades
3. **Equity Curve Chart** — Portfolio value over time with optional benchmark overlay
4. **Drawdown Chart** — Underwater plot showing drawdown % over time
5. **Rolling 12-Month Metrics** — Rolling annualized return and rolling Sharpe (only shown when >= 252 data points)
6. **Monthly Returns Heatmap** — Color-coded Year x Month table with YTD column
7. **Trade Statistics** — Avg win/loss, payoff ratio, expectancy, holding periods, max consecutive wins/losses
8. **Recent Trades** — Table of last 20 trades with entry/exit dates, prices, PnL, return %

**Edge cases handled:**
- Empty trades list (shows "No trades executed")
- Short backtest periods (omits rolling metrics section)
- Missing benchmark data (omits benchmark overlay and header line)
- Insufficient data for monthly returns

### New file: `tests/test_tearsheet.py`

21 tests covering:
- `TestGenerateTearsheet` (10 tests): file output, HTML validity, key sections present, self-containment check, empty trades, short periods, benchmark data, strategy name, custom output path
- `TestRenderChartAsBase64` (3 tests): valid base64 output, decodable PNG bytes, figure closure
- `TestGenerateMonthlyReturnsHtml` (4 tests): table structure, YTD column, short series handling, insufficient data
- `TestGenerateTradeTableHtml` (4 tests): trade rendering, row limiting, empty trades, PnL CSS classes

## Test results

- 21 new tests: all passing
- 492 total tests: all passing (no regressions)

## Dependencies

Uses only existing project dependencies: matplotlib, pandas, numpy. No new packages added.

## Files changed

- `src/backtester/analytics/tearsheet.py` (new)
- `tests/test_tearsheet.py` (new)
